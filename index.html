<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.553.0.min.js"></script>
    <style>
    #overlay {
      position: absolute; /* Sit on top of the page content */
      display: none; /* Hidden by default */
      width: 100%; /* Full width (cover the whole page) */
      height: 100%; /* Full height (cover the whole page) */
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8); /* Black background with opacity */
      z-index: 10; /* Specify a stack order in case you're using a different order for other elements */
      cursor: pointer; /* Add a pointer on hover */
    }
  </style>
  </head>
  <body>
    <div class="row mt-4">
      <div class="col-md-6 mx-auto">
        <h2>Instructions</h2>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6 mx-auto border rounded">
        <p class="text-left mt-4">
          You should have been provided with an 
          <ul>
            <li><b>Access Key ID</b></li>
            <li><b>Access Key Secret</b></li>
            <li><b>Email Address</b></li>
          </ul>

          You will receive an <b>Object Key</b> from this page following a successful upload.

        </p>
        <p class="text-left">
          You should send this Submission ID to the provided email address along with the password
          required to decrypt your submission. Your submission must be inside an encrypted archive
          created using 7zip.
        </p>
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mx-auto">
        <h2>Upload</h2>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6 mx-auto border rounded">
        <div id="overlay" class="border rounded pt-4">
          <center>
            <font color="white">Your upload is in progress, please do not navigate away from this page.</font>
          </center>
        </div>
        <div class="custom-file mt-4 mb-2">
          <input id="objectupload" type="file" accept="*" class="custom-file-input">
          <label class="custom-file-label overflow-hidden" for="objectupload">Choose file</label>
        </div>
        <script>
            $('#objectupload').on('change',function(){
                //get the file name
                var fileName = $(this).val();
                //replace the "Choose a file" label
                $(this).next('.custom-file-label').html(fileName);
            })
        </script>
        <div class="form-group">
          <label for="keyid">Access Key ID:</label>
          <input type="text" class="form-control" name="keyid" id="keyid">
        </div>
        <div class="form-group">
          <label for="keysecret">Access Key Secret:</label>
          <input type="password" class="form-control" name="keysecret" id="keysecret">
        </div>
        <div class="form-check  form-check-inline mb-2">
          <input class="form-check-input" type="checkbox" value="" id="acceptanceCheck">
          <label class="form-check-label" for="acceptanceCheck">
            The data being submitted conforms to the <a href='#'>submission guidelines</a>.
          </label>
        </div>
        <div class="form-group">
          <button id="addobject" onclick="Upload()" class="btn btn-primary">Upload</button>
        </div>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-md-6 mx-auto border rounded">
        <div id="progress" class="progress mt-2">
          <div class="progress-bar progress-bar-success"></div>
        </div>
        <div class="progress-number mb-2">n/a</div>
      </div>
    </div>
  </body>
</html>

<script>
  var bucketName = "uploader-test-tomcatling";
  var bucketRegion = "eu-west-2";

  AWS.config.region = bucketRegion;
  AWS.config.httpOptions.timeout = 0; 


  function getReadableFileSizeString(fileSizeInBytes) {
      var i = -1;
      var byteUnits = [' KB', ' MB', ' GB', ' TB', 'PB', 'EB', 'ZB', 'YB'];
      do {
          fileSizeInBytes = fileSizeInBytes / 1024;
          i++;
      } while (fileSizeInBytes > 1024);

      return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
  }

  function fixFilename(username, filename) {
    var cleanfilename = filename.replace(/[^a-zA-Z0-9\.\-\_]+/g,"");
    return username + '/' + cleanfilename
  }

  function validateInputs() {
    var files = document.getElementById("objectupload").files;
    if (!files.length) {
      return "Please choose a file to upload first.";
    }

    var keyid = document.getElementById("keyid").value;
    var keysecret = document.getElementById("keysecret").value;
    var checked = document.getElementById("acceptanceCheck").checked;

    if (keyid === "" || keysecret === "") {
      return "Please enter credentials first.";
    }

    if (!checked) {
      return "Please confirm that the data being submitted conforms to our guidelines.";
    }

  }

  function lockForm() {
    document.getElementById("overlay").style.display = 'block';
  }

  function unlockForm() {
    document.getElementById("overlay").style.display = 'none';
  }

  function Upload() {


    var msg = validateInputs()
    if (msg) {
      return alert(msg);
    }

    lockForm();

    var file = document.getElementById("objectupload").files[0];
    var keyid = document.getElementById("keyid").value;
    var keysecret = document.getElementById("keysecret").value;
    var objectKey = file.name;

    var s3 = new AWS.S3({
      apiVersion: "2006-03-01",
      useAccelerateEndpoint: true,
      clientSideMonitoring: true,
      computeChecksums: true,
      sslEnabled: true,
      accessKeyId: keyid,
      secretAccessKey: keysecret
    });

    $('#progress .progress-bar').css('width',"0px");
    $('#progress .progress-number').text("");
    lockForm();

    // Use S3 ManagedUpload class as it supports multipart uploads
    managedUpload = s3.upload(
    params = {
      Bucket: bucketName,
      Key: objectKey,
      Body: file,
      ACL: "private",
      ServerSideEncryption: 'AES256',
    },
    options = {
      partSize: Math.max(file.size / 1000, 5 * 1024 * 1024),
      queueSize: 4
    });

    managedUpload.on('httpUploadProgress', function(progress) {
      var progress = (progress.loaded * 100) / file.size;
      var progressInt = parseInt(progress)
      lockForm();
      $('#progress .progress-bar').css('width',progressInt + '%');
      $(".progress-number").html(
        getReadableFileSizeString(file.size * progress / 100)+" / "+getReadableFileSizeString(file.size)
        );
    });

    managedUpload.send(function (err, data) {
      if (err){
        unlockForm();
        $(".progress-number").html(
          '<font color="red">'
          + err
          + '</font>');
        console.log(err);
        this.abort()
      }
      else {
        unlockForm();
        $(".progress-number").html(
          'Upload complete. <br> Object has the key: <font color="red">' 
          + bucketName 
          + '/' 
          + objectKey 
          +'</font>'
          )
      }
    });
  }
</script>